<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner de Document avec OCR.space</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            max-width: 100%;
            overflow-x: hidden;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }
        
        .capture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            max-width: 500px;
            height: auto;
            background-color: #000;
            margin-bottom: 10px;
            display: none;
        }
        
        #canvas {
            display: none;
        }
        
        .img-container {
            width: 100%;
            max-width: 500px;
            margin-bottom: 15px;
            display: none;
        }
        
        #captured-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        #result-text {
            white-space: pre-wrap;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .cropper-container {
            margin: 0 auto;
            max-width: 500px;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading p {
            margin-top: 10px;
            color: #666;
        }
        
        .lang-select {
            margin-bottom: 15px;
            text-align: center;
        }
        
        #language-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            button {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scanner de Document</h1>
        
        <div class="capture-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            
            <div class="img-container">
                <img id="captured-image" alt="Image capturée">
            </div>
            </div>
            
            <div class="button-group">
                <button id="start-camera">Activer la caméra</button>
                <button id="take-photo" disabled>Prendre la photo</button>
                <button id="crop-btn" disabled>Rogner</button>
                <button id="scan-btn" disabled>Extraire le texte</button>
                <button id="save-btn" disabled>Sauvegarder</button>
                <button id="reset-btn">Recommencer</button>
            </div>
        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>Extraction du texte en cours...</p>
        </div>
        
        <div id="result-container">
            <h3>Texte extrait:</h3>
            <pre id="result-text"></pre>
        </div>
    </div>

    <script>
        // Clé d'API OCR.space
        const apiKey = "K89517877488957";
        
        // Éléments DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('captured-image');
        const imgContainer = document.querySelector('.img-container');
        const resultContainer = document.getElementById('result-container');
        const resultText = document.getElementById('result-text');
        const loadingDiv = document.querySelector('.loading');
        const languageSelect = document.getElementById('language-select');
        
        // Boutons
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const cropBtn = document.getElementById('crop-btn');
        const scanBtn = document.getElementById('scan-btn');
        const saveBtn = document.getElementById('save-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Variables globales
        let stream = null;
        let cropper = null;
        let extractedText = '';
        
        // Démarrer la caméra
        startCameraBtn.addEventListener('click', async () => {
            try {
                // Utiliser la caméra arrière sur mobile
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.style.display = 'block';
                takePhotoBtn.disabled = false;
                startCameraBtn.disabled = true;
            } catch (err) {
                console.error('Erreur d\'accès à la caméra:', err);
                alert('Erreur d\'accès à la caméra. Vérifiez que vous avez autorisé l\'accès.');
            }
        });
        
        // Prendre une photo
        takePhotoBtn.addEventListener('click', () => {
            const context = canvas.getContext('2d');
            // Ajuster les dimensions du canvas à celles de la vidéo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dessiner l'image de la vidéo sur le canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir le canvas en URL de données
            const imageDataURL = canvas.toDataURL('image/png');
            
            // Afficher l'image capturée
            capturedImage.src = imageDataURL;
            imgContainer.style.display = 'block';
            
            // Arrêter la vidéo
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
            }
            
            // Activer les boutons appropriés
            takePhotoBtn.disabled = true;
            cropBtn.disabled = false;
            scanBtn.disabled = false;
            
            // Initialiser le cropper
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(capturedImage, {
                viewMode: 1,
                dragMode: 'move',
                aspectRatio: NaN,
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: true,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: true,
            });
        });
        
        // Rogner l'image
        cropBtn.addEventListener('click', () => {
            if (!cropper) return;
            
            // Obtenir l'image rognée
            const croppedCanvas = cropper.getCroppedCanvas({
                maxWidth: 1920,
                maxHeight: 1080,
                fillColor: '#fff'
            });
            
            if (croppedCanvas) {
                // Convertir le canvas rogné en URL de données
                const croppedImageDataURL = croppedCanvas.toDataURL('image/png');
                
                // Mettre à jour l'image affichée
                cropper.destroy();
                capturedImage.src = croppedImageDataURL;
                
                // Réinitialiser le cropper avec la nouvelle image
                cropper = new Cropper(capturedImage, {
                    viewMode: 1,
                    dragMode: 'move',
                    aspectRatio: NaN,
                    autoCropArea: 0.8,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: true,
                });
            }
        });
        
        // Fonction pour convertir Data URL en Blob
        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            
            return new Blob([uInt8Array], { type: contentType });
        }
        
        // Extraire le texte avec OCR.space API
        scanBtn.addEventListener('click', async () => {
            if (!cropper) return;
            
            try {
                // Obtenir l'image finale rognée
                const finalCanvas = cropper.getCroppedCanvas({
                    maxWidth: 1920,
                    maxHeight: 1080,
                    fillColor: '#fff'
                });
                
                if (finalCanvas) {
                    // Afficher le chargement
                    loadingDiv.style.display = 'block';
                    scanBtn.disabled = true;
                    
                    // Convertir le canvas en URL de données puis en Blob
                    const finalImageDataURL = finalCanvas.toDataURL('image/png');
                    const blob = dataURLtoBlob(finalImageDataURL);
                    
                    // Créer FormData pour l'envoi
                    const formData = new FormData();
                    formData.append('apikey', apiKey);
                    formData.append('OCREngine', '2'); // Engine 2 est meilleur pour les petits textes
                    formData.append('scale', 'true'); // Améliore la détection des petits textes
                    formData.append('detectOrientation', 'true');
                    formData.append('isTable', 'false');
                    formData.append('file', blob, 'image.png');
                    
                    // Appeler l'API OCR.space
                    const response = await fetch('https://api.ocr.space/parse/image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.OCRExitCode === 1) {
                        // Succès
                        extractedText = data.ParsedResults.map(result => result.ParsedText).join('\n');
                        resultText.textContent = extractedText;
                        resultContainer.style.display = 'block';
                        saveBtn.disabled = false;
                    } else {
                        // Erreur
                        alert(`Erreur d'OCR: ${data.ErrorMessage || 'Impossible d\'extraire le texte'}`);
                    }
                    
                    // Masquer le chargement
                    loadingDiv.style.display = 'none';
                    scanBtn.disabled = false;
                    
                } else {
                    alert('Impossible de traiter l\'image.');
                }
                
            } catch (err) {
                console.error('Erreur lors de l\'extraction du texte:', err);
                alert('Erreur lors de l\'extraction du texte. Veuillez réessayer.');
                loadingDiv.style.display = 'none';
                scanBtn.disabled = false;
            }
        });
        
        // Sauvegarder le document
        saveBtn.addEventListener('click', () => {
            if (!extractedText) return;
            
            // Demander le nom du document
            const docName = prompt('Nom du document:', 'Document_scanné');
            
            if (docName) {
                // Créer un blob avec le texte
                const blob = new Blob([extractedText], { type: 'text/plain' });
                
                // Créer un lien de téléchargement
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                a.href = url;
                a.download = `${docName}.txt`;
                
                // Déclencher le téléchargement
                document.body.appendChild(a);
                a.click();
                
                // Nettoyer
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        });
        
        // Réinitialiser l'application
        resetBtn.addEventListener('click', () => {
            // Arrêter la vidéo si elle est en cours
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            // Détruire le cropper s'il existe
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            // Réinitialiser l'interface
            video.style.display = 'none';
            imgContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            loadingDiv.style.display = 'none';
            
            // Réinitialiser les boutons
            startCameraBtn.disabled = false;
            takePhotoBtn.disabled = true;
            cropBtn.disabled = true;
            scanBtn.disabled = true;
            saveBtn.disabled = true;
            
            // Effacer le texte extrait
            extractedText = '';
            resultText.textContent = '';
        });
    </script>
</body>